#!/bin/bash

# ะกะบัะธะฟั ะดะปั ะฑััััะพะณะพ ะดะตะฟะปะพั ะฟัะธะปะพะถะตะฝะธั
# ะัะฟะพะปัะทะพะฒะฐะฝะธะต: ./deploy.sh

set -e

echo "๐ ะะฐัะธะฝะฐะตะผ ะดะตะฟะปะพะน Top Drink Coffee..."

# ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั Docker
if ! command -v docker &> /dev/null; then
    echo "โ Docker ะฝะต ัััะฐะฝะพะฒะปะตะฝ. ะฃััะฐะฝะพะฒะธัะต Docker ะธ ะฟะพะฟัะพะฑัะนัะต ัะฝะพะฒะฐ."
    exit 1
fi

# ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั Docker Compose
if ! docker compose version &> /dev/null; then
    echo "โ Docker Compose ะฝะต ัััะฐะฝะพะฒะปะตะฝ. ะฃััะฐะฝะพะฒะธัะต Docker Compose ะธ ะฟะพะฟัะพะฑัะนัะต ัะฝะพะฒะฐ."
    exit 1
fi

# ะัะพะฒะตัะบะฐ ะฝะฐะปะธัะธั .env ัะฐะนะปะฐ
if [ ! -f .env ]; then
    echo "โ๏ธ  ะคะฐะนะป .env ะฝะต ะฝะฐะนะดะตะฝ. ะกะพะทะดะฐะตะผ ะธะท .env.example..."
    cp .env.example .env
    echo "โ ะคะฐะนะป .env ัะพะทะดะฐะฝ. ะะะะะ: ะััะตะดะฐะบัะธััะนัะต .env ะธ ะธะทะผะตะฝะธัะต JWT_SECRET!"
    echo "   ะะปั ะณะตะฝะตัะฐัะธะธ ัะตะบัะตัะฝะพะณะพ ะบะปััะฐ ะธัะฟะพะปัะทัะนัะต: openssl rand -base64 32"
    read -p "ะะฐะถะผะธัะต Enter ะฟะพัะปะต ัะตะดะฐะบัะธัะพะฒะฐะฝะธั .env ัะฐะนะปะฐ..."
fi

# ะกะพะทะดะฐะฝะธะต ะฝะตะพะฑัะพะดะธะผัั ะดะธัะตะบัะพัะธะน
echo "๐ ะกะพะทะดะฐะตะผ ะฝะตะพะฑัะพะดะธะผัะต ะดะธัะตะบัะพัะธะธ..."
mkdir -p data nginx/logs nginx/ssl
chmod 755 data nginx/logs

# ะััะฐะฝะพะฒะบะฐ ััะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ (ะตัะปะธ ะตััั)
echo "๐ ะััะฐะฝะฐะฒะปะธะฒะฐะตะผ ััะฐััะต ะบะพะฝัะตะนะฝะตัั..."
docker compose down 2>/dev/null || true

# ะกะฑะพัะบะฐ ะธ ะทะฐะฟััะบ
echo "๐จ ะกะพะฑะธัะฐะตะผ ะธ ะทะฐะฟััะบะฐะตะผ ะบะพะฝัะตะนะฝะตัั..."
docker compose up -d --build

# ะะถะธะดะฐะฝะธะต ะทะฐะฟััะบะฐ
echo "โณ ะะถะธะดะฐะตะผ ะทะฐะฟััะบ ะฟัะธะปะพะถะตะฝะธั..."
sleep 10

# ะัะพะฒะตัะบะฐ ััะฐัััะฐ
echo "๐ ะัะพะฒะตััะตะผ ััะฐััั ะบะพะฝัะตะนะฝะตัะพะฒ..."
docker compose ps

# ะัะพะฒะตัะบะฐ health check
echo "๐ฅ ะัะพะฒะตััะตะผ health check..."
if curl -f http://localhost/health &> /dev/null; then
    echo "โ ะัะธะปะพะถะตะฝะธะต ััะฟะตัะฝะพ ะทะฐะฟััะตะฝะพ!"
else
    echo "โ๏ธ  Health check ะฝะต ะฟัะพัะตะป. ะัะพะฒะตัััะต ะปะพะณะธ: docker compose logs"
fi

# ะัะฒะพะด ะธะฝัะพัะผะฐัะธะธ
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo "โ ะะตะฟะปะพะน ะทะฐะฒะตััะตะฝ!"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo ""
echo "๐ ะัะธะปะพะถะตะฝะธะต ะดะพัััะฟะฝะพ ะฟะพ ะฐะดัะตัั:"
echo "   HTTP: http://localhost"
echo "   ะธะปะธ http://$(hostname -I | awk '{print $1}')"
echo ""
echo "๐ค ะะดะผะธะฝ-ะฟะฐะฝะตะปั:"
echo "   URL: http://localhost/admin"
echo "   ะะพะณะธะฝ: admin"
echo "   ะะฐัะพะปั: admin123"
echo "   โ๏ธ  ะะะะะ: ะกะผะตะฝะธัะต ะฟะฐัะพะปั ะฟะพัะปะต ะฟะตัะฒะพะณะพ ะฒัะพะดะฐ!"
echo ""
echo "๐ ะะพะปะตะทะฝัะต ะบะพะผะฐะฝะดั:"
echo "   ะะพะณะธ:           docker compose logs -f"
echo "   ะะตัะตะทะฐะฟััะบ:     docker compose restart"
echo "   ะััะฐะฝะพะฒะบะฐ:      docker compose down"
echo "   ะะฑะฝะพะฒะปะตะฝะธะต:     git pull && docker compose up -d --build"
echo ""
echo "๐ ะะปั ะฝะฐัััะพะนะบะธ HTTPS ัะผะพััะธัะต DEPLOYMENT.md (ะจะฐะณ 3)"
echo ""
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

